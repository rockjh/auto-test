# 自动生成 Swagger 接口测试场景 PRD

## 一、项目背景与目标
- 解决 QA 手工整理接口命令和构造入参效率低的问题，自动解析 Swagger 生成可维护的 `curl` 模板，并基于配置执行顺序和依赖关系，快速构建回归测试场景。
- 支撑持续更新的 Swagger 文档，保证测试场景与接口文档同步演进，减少沟通成本，提升覆盖率与执行效率。

## 二、范围定义
- **包含**：Swagger 扫描解析、参数组合与随机生成策略、`curl` 模板管理、项目级环境配置（Host/Header）、场景配置与顺序执行、自研执行器、执行日志与差异提醒。
- **不包含**：Swagger 文档编写维护、接口真实业务 Mock、CI/CD 集成（后续扩展）、复杂 BPMN 流程编排。

## 三、用户画像
- **QA 工程师**：主要使用者，生成命令、配置场景、查看执行结果。
- **开发工程师**：辅助者，提供 Swagger、确认参数规则、排查异常。
- **测试负责人**：关注覆盖度、失败率、执行历史。

## 四、用户旅程
1. 登录系统查看工作台 → 选择或导入 Swagger。
2. 系统解析生成项目/集合/分组 → QA 浏览接口详情与随机规则。
3. QA 选定接口生成 `curl` 模板 → 在场景编排页拖拽排序步骤。
4. 配置依赖关系和变量映射，选择或新建项目环境（Host/Header）→ 保存场景。
5. 触发场景执行，确认运行环境 → 查看执行时间轴、请求/响应与变量轨迹。
6. Swagger 更新 → 触发分组重生成 → 预览差异 → 同步场景。

## 五、核心功能需求

### 1. Swagger 解析与维护
- 支持导入 Swagger URL/文件；解析层级：`Project`(Swagger) → `Collection`(Tag) → `Group`(接口)。
- 监测版本或 Tag 更新；可选单分组重生成，覆盖/追加 `curl` 模板。
- 记录解析时间、来源版本、差异（新增/删除接口、参数变动）。

### 2. `curl` 模板生成
- 每个接口生成 **最小必填参数模板** 与 **全量参数模板**；根据可选参数组合可扩展更多变体。
- 参数随机化：按 `type/format/pattern/enum/description` 自动匹配随机策略，支持内置规则（手机号、邮箱、日期、正则、枚举权重等）。
- 模板内使用变量占位符；执行前按策略生成动态值，可查看实时预览。
- 可手动补充/覆盖随机规则，记录更新人和时间。

### 3. 数据存储结构
- 维度：`Project` → `Collection` → `Group` → `CurlVariant`。
- 存储内容：`curl` 模板、变量规则、随机策略、Swagger 元数据、生成历史。
- 记录 `swagger_hash` 与 `rule_version`，重生成时可对比变更并决定是否覆盖。
- 项目级维护环境集合：每个环境包含 `host/baseUrl`、通用请求 Header、备注与启用状态；执行或预览时可选择环境，自动作用于项目下所有 `curl` 模板。

#### 示例字段
```json
{
  "project": {
    "id": 1,
    "name": "Order API",
    "swagger_source": "https://.../order.json",
    "version": "1.2.0",
    "sync_time": "2024-05-01T11:30:00Z",
    "swagger_hash": "f3a9..."
  },
  "environments": [
    {
      "id": 201,
      "project_id": 1,
      "name": "SIT",
      "host": "https://sit.example.com",
      "headers": {
        "X-Tenant": "qa",
        "Authorization": "Bearer \\${token}"
      },
      "is_default": true
    }
  ],
  "group": {
    "id": 1001,
    "collection_id": 10,
    "path": "/orders/{id}",
    "method": "GET",
    "summary": "获取订单详情",
    "hash": "c812..."
  },
  "curl_variant": {
    "id": 50001,
    "group_id": 1001,
    "type": "minimal",
    "curl_template": "curl -X GET ...",
    "param_rules": {
      "path.id": { "type": "number", "range": [1, 999999], "sample": 123456 },
      "header.Authorization": { "type": "token", "generator": "jwtTemplate" }
    },
    "rule_version": "20240501"
  }
}
```

### 4. 参数随机化与对齐流程
- 挑选 **1 个复杂 + 1 个简单** Swagger 样例；整理字段映射表：包含 method/path、参数位置、类型、必填、enum/pattern/format、描述、拟定随机策略。
- 制作随机策略模板：列出类型 → 默认策略 → 示例输出 → fallback；对语义字段（手机号/邮箱等）及特殊类型（数组、嵌套对象、文件）提供说明。
- 样例生成后的模型数据用于验证字段充分性，缺口在评审中确认。
- 评审规则覆盖范围，记录例外处理方案；案例沉淀到共享文档。

### 5. 场景编排与保存
- 场景选择层级：项目 → 集合 → 分组 → `curl` 模板；支持同一接口多次复用。
- 场景关联项目环境：创建或执行时可选择项目内环境，统一注入 `host` 与通用 Header，可在场景中设置默认环境并允许执行时临时切换。
- 场景步骤字段：`curl_variant_id`、顺序、变量映射、重试策略、条件（预留）。
- 支持变量池：场景级变量、步骤输出变量；通过 JSONPath 将上游响应映射到下游请求的任意字段（path/query/header/body）。
- 场景版本管理：记录修改人、时间、备注；支持复制、标签管理。

### 6. 自研执行器
- **执行流程**：读取场景 JSON → 初始化变量上下文 → 顺序遍历步骤：
  1. 构造请求（载入模板、应用所选环境的 `host` 与通用 Header、随机生成参数、变量替换）。
  2. 发起 HTTP 调用 → 记录请求/响应日志。
  3. 解析响应（JSONPath）→ 更新变量池。
  4. 写入执行状态（成功/失败/跳过），保存快照。
- 支持配置：失败是否中断、重试次数/间隔、场景并发限制。
- 执行器以 Spring Boot 模块实现；通过线程池控制并发；场景级隔离；接口限流可选。
- 执行状态与日志持久化数据库，关键指标缓存 Redis，以便恢复和监控。

### 7. 执行结果与监控
- 工作台展示关键指标：执行数量、失败率、最新失败场景。
- 执行记录列表：场景名称、触发人、耗时、状态、时间；可筛选/分页。
- 执行详情页：步骤时间轴、请求/响应详情、变量变化、错误信息；日志可下载。
- 系统监控：接入 Spring Boot Actuator，输出指标到 Prometheus/Grafana；失败触发企业微信/钉钉告警。

### 8. 更新与差异管理
- 单分组重生成：预览差异（新增接口、字段变动、模板差异），手动选择覆盖.
- 记录历史版本；提供差异对比面板；重生成后自动标记需复核的场景。
- Random 规则保留：重生成时自动继承原字段自定义策略，如未匹配则提示人工确认。

### 9. 权限与协作
- 基于 RuoYi 权限模型：区分查看/编辑/执行角色；场景可共享、只读、协作编辑。
- 操作日志：记录生成、修改、执行、重生成等关键事件。

## 六、非功能需求
- **性能**：支持 100+ Swagger、每个 100~300 接口；场景执行单步耗时目标 <3s。
- **扩展性**：执行器支持水平扩展；随机策略可配置新增。
- **稳定性**：日志保留 ≥90 天；执行过程可恢复；系统故障自动告警。
- **安全**：敏感参数加密存储；凭证隔离；操作审计。

## 七、UI 原型建议（RuoYi）
- 侧边导航：`Swagger 项目`/`接口库`/`场景编排`/`执行记录`。
- 工作台：项目列表、最近同步时间、执行统计、失败告警入口。
- 接口浏览：列表+详情页；支持 Tag/关键字过滤；显示参数表、随机策略、`curl` 模板预览。
- `curl` 编辑弹窗：参数规则配置 + 预览；支持实时随机样例。
- 项目环境管理：项目详情页内提供环境列表，支持新增/复制、配置 `host` 与通用 Header、设置默认环境并预览示例。
- 场景编排：左侧接口树 + 中部步骤列表（拖拽排序）+ 下方变量映射表。
- 执行详情：时间轴、日志折叠面板、变量快照；支持 diff 显示。
- 重生成管理：差异对比页面，勾选覆盖选项。

## 八、数据模型草案

| 表 | 关键字段 | 说明 |
| --- | --- | --- |
| `Project` | `id`, `name`, `swagger_source`, `version`, `sync_time`, `swagger_hash` | Swagger 项目维度 |
| `ProjectEnvironment` | `id`, `project_id`, `name`, `host`, `headers`, `is_default`, `status`, `remark` | 项目环境配置（Host/Header 集合） |
| `Collection` | `id`, `project_id`, `tag_name`, `summary` | Swagger Tag |
| `Group` | `id`, `collection_id`, `path`, `method`, `summary`, `hash` | 单个接口定义 |
| `CurlVariant` | `id`, `group_id`, `type`, `curl_template`, `param_rules`, `rule_version` | 模板与随机规则 |
| `Scenario` | `id`, `name`, `project_id`, `status`, `owner`, ` tags`, `metadata` | 测试场景 |
| `ScenarioStep` | `id`, `scenario_id`, `order`, `curl_variant_id`, `dependency_config`, `retry_config` | 场景步骤 |
| `Execution` | `id`, `scenario_id`, `trigger_user`, `start_time`, `end_time`, `status` | 执行记录 |
| `ExecutionLog` | `execution_id`, `step_id`, `request_payload`, `response_payload`, `variables_snapshot`, `error_message` | 步骤日志 |

## 九、关键流程

### 1. Swagger 同步与生成
1. 触发同步（定时/手动）。
2. 下载并解析 Swagger → 生成层级数据。
3. 计算 `group.hash` 对比 → 新增/更新/标记删除。
4. 依据参数组合生成 `curl` 模板；保留或合并原随机规则。
5. 写入数据库，记录版本及时间。

### 2. 场景创建与编排
1. UI 选择项目/接口 → 拖拽步骤 → 配置顺序。
2. 为每个步骤设置变量映射（响应 JSONPath → 请求字段）。
3. 配置场景级变量、默认执行环境（可新建/选择项目环境）、重试策略、执行选项。
4. 保存场景，生成版本记录。

### 3. 场景执行
1. 用户触发执行 → 选择或确认运行环境 → 生成执行实例。
2. 自研执行器串行遍历步骤：构造请求、调用、解析响应、变量赋值。
3. 步骤异常时按策略重试或中断，记录日志。
4. 执行完成后写入汇总状态，发送通知。

### 4. 重生成与差异确认
1. 用户选择分组重生成 → 预览差异。
2. 决定保留/覆盖 `curl` 模板和随机规则。
3. 更新后标记相关场景需复核。

## 十、成功指标
- `curl` 命令生成覆盖率 ≥ 90% 的 Swagger 接口。
- QA 编写接口命令时间减少 70%。
- 场景执行失败定位时间 < 10 分钟。
- Swagger 更新后 1 个工作日内完成对齐。

## 十一、里程碑建议
1. **M1（2 周）**：Swagger 解析、数据模型、最小 `curl` 生成、手动触发。
2. **M2（3 周）**：参数随机化、全量模板、UI 浏览/编辑基础。
3. **M3（3 周）**：场景编排、变量映射、自研执行器核心能力。
4. **M4（2 周）**：执行日志、差异管理、权限控制、告警监控。

## 十二、风险与对策
- **Swagger 描述不规范**：提供手工补充入口，解析异常记录并告警。
- **随机策略复杂度高**：逐步扩展规则库，提供规则测试和示例预览。
- **依赖映射维护成本**：在 UI 中展示接口返回字段结构，提供自动建议。
- **执行失败排查困难**：保存完整日志和变量轨迹，支持 diff 对比。
- **自研执行器扩展性**：在场景 JSON 设计中预留类型字段，便于未来扩展条件节点或并行执行。

## 十三、下一步行动
1. 落实样例 Swagger、字段映射表和随机策略模板，组织对齐评审。
2. 设计场景 JSON schema（步骤结构、变量规则、重试策略），并草拟执行器流程图。
3. 梳理项目环境配置结构（字段、继承/覆盖规则、权限），并输出 UI/接口设计草稿。
4. 在 RuoYi 中绘制低保真 UI 原型，确认交互路径与组件选型。
5. 明确监控告警方案与日志存储规范，为执行器上线做好准备。
